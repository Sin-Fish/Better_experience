plugins {
    id 'fabric-loom' version '1.6-SNAPSHOT'
    id 'maven-publish'
}

version = project.mod_version
group = project.maven_group

repositories {
    // Add repositories to retrieve artifacts from in here.
    // You should only use this when depending on other mods because
    // Loom adds the essential maven repositories to download Minecraft and libraries from automatically.
    // See https://docs.gradle.org/current/userguide/declaring_repositories.html
    // for more information about repositories.
}

dependencies {
    // To change the versions see the gradle.properties file
    minecraft "com.mojang:minecraft:${project.minecraft_version}"

    mappings "net.fabricmc:yarn:${project.yarn_mappings}:v2"
    modImplementation "net.fabricmc:fabric-loader:${project.loader_version}"

    // Fabric API. This is technically optional, but you probably want it anyway.
    modImplementation "net.fabricmc.fabric-api:fabric-api:${project.fabric_version}"
    
    // Gson for JSON parsing
    implementation 'com.google.code.gson:gson:2.10.1'
}

processResources {
    inputs.property "version", project.version
    filteringCharset "UTF-8"

    filesMatching("fabric.mod.json") {
        expand "version": project.version
    }
}

def targetJavaVersion = 17
tasks.withType(JavaCompile).configureEach {
    // ensure that the encoding is set to UTF-8, no matter what the system default is
    // this fixes some edge cases with special characters not displaying correctly
    // see http://yodaconditions.net/blog/fix-for-java-file-encoding-problems-with-gradle.html
    // If Javadoc is generated, this must be specified in that task too.
    it.options.encoding = "UTF-8"
    if (targetJavaVersion >= 10 || JavaVersion.current().isJava10Compatible()) {
        it.options.release = targetJavaVersion
    }
}

java {
    def javaVersion = JavaVersion.toVersion(targetJavaVersion)
    if (JavaVersion.current() < javaVersion) {
        toolchain.languageVersion = JavaToolchainSpec.LanguageVersion.of(targetJavaVersion)
    }
    archivesBaseName = project.archives_base_name
    // Loom will automatically attach sourcesJar to a RemapSourcesJar task and to the "build" task
    // if it is present.
    // If you remove this line, sources will not be generated.
    withSourcesJar()
}

jar {
    from("LICENSE") {
        rename { "${it}_${project.archivesBaseName}"}
    }
}

// configure the maven publication
publishing {
    publications {
        mavenJava(MavenPublication) {
            from components.java
        }
    }

    // See https://docs.gradle.org/current/userguide/publishing_maven.html for information on how to set up publishing.
    repositories {
        // Add repositories to publish to here.
        // Notice: This block does NOT have the same function as the block in the top level.
        // The repositories here will be used for publishing your artifact, not for
        // retrieving dependencies.
    }
}

// å¤šç‰ˆæœ¬æ„å»ºè„šæœ¬
// Multi-version build script

def supportedVersions = [
    "1.21.0",
    "1.21.1", 
    "1.21.2",
    "1.21.3",
    "1.21.4",
    "1.21.5",
    "1.21.6",
    "1.21.7",
    "1.21.8",
    "1.21.9",
    "1.21.10"
]

// æ”¹è¿›çš„ç‰ˆæœ¬éªŒè¯ä»»åŠ¡
task validateVersions {
    group = 'verification'
    description = 'éªŒè¯æ‰€æœ‰æ”¯æŒçš„Minecraftç‰ˆæœ¬'
    
    doLast {
        println "=== ç‰ˆæœ¬å…¼å®¹æ€§éªŒè¯ ==="
        println "æ”¯æŒçš„ç‰ˆæœ¬èŒƒå›´: 1.21.0 - 1.21.10"
        println "å½“å‰æ„å»ºç‰ˆæœ¬: ${project.minecraft_version}"
        
        // æ£€æŸ¥å½“å‰æ„å»ºç‰ˆæœ¬æ˜¯å¦åœ¨æ”¯æŒèŒƒå›´å†…
        def currentVersion = project.minecraft_version
        def isSupported = supportedVersions.contains(currentVersion)
        
        if (isSupported) {
            println "âœ… å½“å‰ç‰ˆæœ¬ ${currentVersion} åœ¨æ”¯æŒèŒƒå›´å†…"
        } else {
            println "âŒ å½“å‰ç‰ˆæœ¬ ${currentVersion} ä¸åœ¨æ”¯æŒèŒƒå›´å†…"
            println "æ”¯æŒçš„ç‰ˆæœ¬: ${supportedVersions.join(', ')}"
            throw new GradleException("ç‰ˆæœ¬ä¸å…¼å®¹ï¼è¯·ä½¿ç”¨æ”¯æŒçš„ç‰ˆæœ¬ã€‚")
        }
        
        // æ£€æŸ¥Fabric APIç‰ˆæœ¬å…¼å®¹æ€§
        def fabricVersion = project.fabric_version
        println "Fabric APIç‰ˆæœ¬: ${fabricVersion}"
        
        // æ£€æŸ¥Yarn mappingsç‰ˆæœ¬
        def yarnVersion = project.yarn_mappings
        println "Yarn mappingsç‰ˆæœ¬: ${yarnVersion}"
        
        // æ£€æŸ¥Javaç‰ˆæœ¬
        def javaVersion = System.getProperty('java.version')
        println "Javaç‰ˆæœ¬: ${javaVersion}"
        
        // æ£€æŸ¥Gradleç‰ˆæœ¬
        def gradleVersion = project.gradle.gradleVersion
        println "Gradleç‰ˆæœ¬: ${gradleVersion}"
        
        // æ£€æŸ¥é¡¹ç›®ç»“æ„
        println ""
        println "=== é¡¹ç›®ç»“æ„æ£€æŸ¥ ==="
        
        def requiredFiles = [
            'src/main/java/com/aeolyn/better_experience/BetterExperienceMod.java',
            'src/main/resources/fabric.mod.json',
            'src/main/resources/better_experience.mixins.json'
        ]
        
        requiredFiles.each { file ->
            if (new File(file).exists()) {
                println "âœ… ${file}"
            } else {
                println "âŒ ${file} (ç¼ºå¤±)"
            }
        }
        
        // æ£€æŸ¥é…ç½®æ–‡ä»¶
        println ""
        println "=== é…ç½®æ–‡ä»¶æ£€æŸ¥ ==="
        
        def configFiles = [
            'src/main/resources/assets/better_experience/render3d/items.json',
            'src/main/resources/assets/better_experience/offhand/offhand_restrictions.json'
        ]
        
        configFiles.each { file ->
            if (new File(file).exists()) {
                println "âœ… ${file}"
            } else {
                println "âŒ ${file} (ç¼ºå¤±)"
            }
        }
        
        println ""
        println "=== éªŒè¯å®Œæˆ ==="
        println "âš ï¸  æ³¨æ„ï¼šè¿™åªæ˜¯é…ç½®æ£€æŸ¥ï¼Œå®é™…å…¼å®¹æ€§éœ€è¦åœ¨Minecraftä¸­æµ‹è¯•"
    }
}

// åœ¨æ„å»ºå‰æ‰§è¡Œç‰ˆæœ¬éªŒè¯
build.dependsOn validateVersions

task buildAllVersions {
    group = 'build'
    description = 'æ„å»ºæ‰€æœ‰æ”¯æŒçš„Minecraftç‰ˆæœ¬'
    
    doLast {
        println "å¼€å§‹æ„å»ºæ‰€æœ‰æ”¯æŒçš„ç‰ˆæœ¬..."
        
        supportedVersions.each { version ->
            println "æ„å»ºç‰ˆæœ¬: $version"
            
            // è®¾ç½®ç‰ˆæœ¬ç‰¹å®šçš„å±æ€§
            project.ext.minecraft_version = version
            project.ext.yarn_mappings = "${version}+build.1"
            project.ext.fabric_version = "0.128.1+${version}"
            
            // æ‰§è¡Œæ„å»º
            exec {
                commandLine './gradlew', 'build', '-Pminecraft_version=' + version
            }
        }
        
        println "æ‰€æœ‰ç‰ˆæœ¬æ„å»ºå®Œæˆï¼"
    }
}

task testAllVersions {
    group = 'verification'
    description = 'æµ‹è¯•æ‰€æœ‰æ”¯æŒçš„Minecraftç‰ˆæœ¬'
    
    doLast {
        println "å¼€å§‹æµ‹è¯•æ‰€æœ‰æ”¯æŒçš„ç‰ˆæœ¬..."
        
        supportedVersions.each { version ->
            println "æµ‹è¯•ç‰ˆæœ¬: $version"
            
            // è®¾ç½®ç‰ˆæœ¬ç‰¹å®šçš„å±æ€§
            project.ext.minecraft_version = version
            project.ext.yarn_mappings = "${version}+build.1"
            project.ext.fabric_version = "0.128.1+${version}"
            
            // æ‰§è¡Œæµ‹è¯•
            exec {
                commandLine './gradlew', 'test', '-Pminecraft_version=' + version
            }
        }
        
        println "æ‰€æœ‰ç‰ˆæœ¬æµ‹è¯•å®Œæˆï¼"
    }
}

// ä¸ºæ¯ä¸ªç‰ˆæœ¬åˆ›å»ºå•ç‹¬çš„æ„å»ºä»»åŠ¡
supportedVersions.each { version ->
    task "build${version.replace('.', '')}" {
        group = 'build'
        description = "æ„å»ºMinecraft ${version}ç‰ˆæœ¬"
        
        doLast {
            println "æ„å»ºç‰ˆæœ¬: $version"
            
            // è®¾ç½®ç‰ˆæœ¬ç‰¹å®šçš„å±æ€§
            project.ext.minecraft_version = version
            project.ext.yarn_mappings = "${version}+build.1"
            project.ext.fabric_version = "0.128.1+${version}"
            
            // æ‰§è¡Œæ„å»º
            exec {
                commandLine './gradlew', 'build', '-Pminecraft_version=' + version
            }
        }
    }
}

// å®ç”¨çš„æµ‹è¯•ä»»åŠ¡
task testModCompatibility {
    group = 'verification'
    description = 'æµ‹è¯•modå…¼å®¹æ€§ï¼ˆéœ€è¦Minecraftè¿è¡Œç¯å¢ƒï¼‰'
    
    doLast {
        println "=== Modå…¼å®¹æ€§æµ‹è¯• ==="
        println "âš ï¸  è¿™ä¸ªæµ‹è¯•éœ€è¦Minecraftè¿è¡Œç¯å¢ƒ"
        println ""
        println "æµ‹è¯•æ­¥éª¤ï¼š"
        println "1. è¿è¡Œ ./gradlew runClient"
        println "2. æ£€æŸ¥å¯åŠ¨æ—¥å¿—ä¸­çš„ç‰ˆæœ¬å…¼å®¹æ€§ä¿¡æ¯"
        println "3. æµ‹è¯•modåŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ"
        println "4. æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯æˆ–è­¦å‘Šä¿¡æ¯"
        println ""
        println "é¢„æœŸè¾“å‡ºï¼š"
        println "âœ… ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥é€šè¿‡"
        println "âœ… Better Experience mod åˆå§‹åŒ–å®Œæˆ"
        println "âœ… é€šç”¨3Dæ¸²æŸ“ç³»ç»Ÿå’Œå‰¯æ‰‹é™åˆ¶ç³»ç»Ÿå·²å¯ç”¨"
        println ""
        println "å¦‚æœçœ‹åˆ°é”™è¯¯ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ï¼š"
        println "- Minecraftç‰ˆæœ¬æ˜¯å¦åœ¨æ”¯æŒèŒƒå›´å†…"
        println "- Fabric APIç‰ˆæœ¬æ˜¯å¦æ­£ç¡®"
        println "- æ˜¯å¦æœ‰å…¶ä»–modå†²çª"
    }
}

// æ¸…ç†å’Œç®€åŒ–æµ‹è¯•ä»»åŠ¡
// Clean and simplified testing tasks

// å¿«é€Ÿæ£€æŸ¥ä»»åŠ¡
task quickCheck {
    group = 'testing'
    description = 'å¿«é€Ÿæ£€æŸ¥é¡¹ç›®é…ç½®å’Œæ–‡ä»¶å®Œæ•´æ€§'
    
    doLast {
        println "=== å¿«é€Ÿé¡¹ç›®æ£€æŸ¥ ==="
        
        // æ£€æŸ¥åŸºæœ¬é…ç½®
        def checks = [
            "Minecraftç‰ˆæœ¬": project.minecraft_version,
            "Fabric API": project.fabric_version,
            "Fabric Loader": project.loader_version,
            "Modç‰ˆæœ¬": project.mod_version
        ]
        
        checks.each { name, value ->
            if (value) {
                println "âœ… ${name}: ${value}"
            } else {
                println "âŒ ${name}: æœªè®¾ç½®"
            }
        }
        
        // æ£€æŸ¥å…³é”®æ–‡ä»¶
        def keyFiles = [
            "ä¸»modç±»": "src/main/java/com/aeolyn/better_experience/BetterExperienceMod.java",
            "Modé…ç½®": "src/main/resources/fabric.mod.json",
            "Mixiné…ç½®": "src/main/resources/better_experience.mixins.json",
            "3Dæ¸²æŸ“é…ç½®": "src/main/resources/assets/better_experience/render3d/items.json",
            "å‰¯æ‰‹é™åˆ¶é…ç½®": "src/main/resources/assets/better_experience/offhand/offhand_restrictions.json"
        ]
        
        println ""
        keyFiles.each { name, path ->
            if (new File(path).exists()) {
                println "âœ… ${name}: å­˜åœ¨"
            } else {
                println "âŒ ${name}: ç¼ºå¤±"
            }
        }
        
        println ""
        println "=== æ£€æŸ¥å®Œæˆ ==="
        println "ğŸ’¡ ä¸‹ä¸€æ­¥ï¼šè¿è¡Œ ./gradlew runClient è¿›è¡Œå®é™…æµ‹è¯•"
    }
}

// å…¼å®¹æ€§åˆ†æä»»åŠ¡
task compatibilityAnalysis {
    group = 'testing'
    description = 'åˆ†æå½“å‰ç‰ˆæœ¬çš„å…¼å®¹æ€§'
    
    doLast {
        println "=== å…¼å®¹æ€§åˆ†æ ==="
        println "åˆ†æç›®æ ‡: Minecraft ${project.minecraft_version}"
        println ""
        
        // æ£€æŸ¥Mixinæ–‡ä»¶
        def mixinFiles = [
            'src/main/java/com/aeolyn/better_experience/mixin/render3d/GenericItemRendererMixin.java',
            'src/main/java/com/aeolyn/better_experience/mixin/offhand/OffHandRestrictionMixin.java'
        ]
        
        mixinFiles.each { file ->
            if (new File(file).exists()) {
                println "âœ… ${file}"
            } else {
                println "âŒ ${file} (ç¼ºå¤±)"
            }
        }
        
        // æ£€æŸ¥ä¾èµ–ç‰ˆæœ¬
        println ""
        def fabricVersion = project.fabric_version
        if (fabricVersion.contains("0.128.1")) {
            println "âœ… Fabric APIç‰ˆæœ¬å…¼å®¹: ${fabricVersion}"
        } else {
            println "âš ï¸  Fabric APIç‰ˆæœ¬å¯èƒ½ä¸å…¼å®¹: ${fabricVersion}"
        }
        
        def javaVersion = System.getProperty('java.version')
        if (javaVersion.startsWith('17') || javaVersion.startsWith('21')) {
            println "âœ… Javaç‰ˆæœ¬å…¼å®¹: ${javaVersion}"
        } else {
            println "âš ï¸  Javaç‰ˆæœ¬å¯èƒ½ä¸å…¼å®¹: ${javaVersion}"
        }
        
        println ""
        println "=== åˆ†æå®Œæˆ ==="
        println "âš ï¸  æ³¨æ„ï¼šè¿™åªæ˜¯é™æ€åˆ†æï¼Œå®é™…å…¼å®¹æ€§éœ€è¦è¿è¡Œæµ‹è¯•"
    }
}

// ä¸€é”®æµ‹è¯•ä»»åŠ¡
task runTests {
    group = 'testing'
    description = 'è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆæ¨èï¼‰'
    
    dependsOn quickCheck, compatibilityAnalysis
    
    doLast {
        println ""
        println "=== æµ‹è¯•å®Œæˆ ==="
        println "ğŸ’¡ ä¸‹ä¸€æ­¥ï¼šè¿è¡Œ ./gradlew runClient è¿›è¡Œå®é™…æ¸¸æˆæµ‹è¯•"
        println "ğŸ“‹ æŸ¥çœ‹ç”Ÿæˆçš„æµ‹è¯•æŠ¥å‘Š"
    }
}

// ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
task generateReport {
    group = 'documentation'
    description = 'ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š'
    
    doLast {
        def reportFile = new File("docs/reports/test-report.md")
        reportFile.text = """# Better Experience Mod æµ‹è¯•æŠ¥å‘Š

## æµ‹è¯•ç¯å¢ƒ
- Minecraftç‰ˆæœ¬: ${project.minecraft_version}
- Fabric API: ${project.fabric_version}
- Fabric Loader: ${project.loader_version}
- æµ‹è¯•æ—¥æœŸ: ${new Date()}

## æµ‹è¯•ç»“æœ

### âœ… é€šè¿‡çš„é¡¹ç›®
- [ ] é¡¹ç›®é…ç½®æ£€æŸ¥
- [ ] æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥
- [ ] ä¾èµ–ç‰ˆæœ¬æ£€æŸ¥
- [ ] å¯åŠ¨æµ‹è¯•
- [ ] 3Dæ¸²æŸ“åŠŸèƒ½æµ‹è¯•
- [ ] å‰¯æ‰‹é™åˆ¶åŠŸèƒ½æµ‹è¯•
- [ ] é…ç½®ç•Œé¢æµ‹è¯•

### âŒ å¤±è´¥çš„é¡¹ç›®
- [ ] å¯åŠ¨é”™è¯¯
- [ ] åŠŸèƒ½å¼‚å¸¸
- [ ] æ€§èƒ½é—®é¢˜

## æ¸¸æˆå†…æµ‹è¯•æ¸…å•

### å¯åŠ¨æµ‹è¯•
- [ ] æ¸¸æˆæ­£å¸¸å¯åŠ¨
- [ ] æ— é”™è¯¯ä¿¡æ¯
- [ ] ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥é€šè¿‡

### åŠŸèƒ½æµ‹è¯•
- [ ] æ‰‹æŒç«æŠŠæ˜¾ç¤º3Dæ•ˆæœ
- [ ] å‰¯æ‰‹é™åˆ¶åŠŸèƒ½æ­£å¸¸
- [ ] æŒ‰Bé”®æ‰“å¼€é…ç½®ç•Œé¢
- [ ] é…ç½®ä¿å­˜æ­£å¸¸

## é—®é¢˜è®°å½•
è¯·åœ¨æ­¤å¤„è®°å½•é‡åˆ°çš„é—®é¢˜

## è§£å†³æ–¹æ¡ˆ
è¯·è®°å½•è§£å†³æ–¹æ¡ˆæˆ–å»ºè®®

---
*æ­¤æŠ¥å‘Šç”±Better Experience Modè‡ªåŠ¨ç”Ÿæˆ*
"""
        
        println "æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ: ${reportFile.absolutePath}"
    }
}
